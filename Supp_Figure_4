## Supplementary Figure S4:

## loading the required R packages 
library(tidyverse)
library(Seurat)
library(ggplot2)
library(survival)
library(survminer)
library(GSVA)
library(dichromat)

## Figure S4A

# Need pre-processing the bulk-RNA seq data of the TCGA-BRCA cohort first: 

deg_myeloid_checkpt_list <- list('PD1' = c("PDCD1"), "SIRPA" = c("SIRPA"), "LILRB2" = c("LILRB2"))

### Calculate the gene enrichment score of myeloid immune checkpoints  
X=as.matrix(exprSet_basal)

es.max_spearman_myeloid_checkpt <- gsva(X, deg_myeloid_checkpt_list, min.sz > 1,
               mx.diff=FALSE, verbose=T, 
               parallel.sz=4)

es.max_spearman_myeloid_checkpt <- t(es.max_spearman_myeloid_checkpt)
es.max_spearman_myeloid_checkpt <- as.data.frame(es.max_spearman_myeloid_checkpt)

#####  KM-survival analysis

for (i in names(deg_myeloid_checkpt_list) ) {
  # i = names(deg_list) [1]
  subset = paste0('',i)
  print(subset)
  v = as.numeric(es.max_myeloid[,i]) 
  sub_group <- ifelse( v < 0,"low","high") 
  table(sub_group) 
  phe$sub_group=sub_group
  # Fit survival curves
  require("survival")
  fit <- survfit(Surv(time, event) ~ sub_group, data = phe)
  library("survminer")
  survp <- ggsurvplot(fit, data = phe,
                      surv.median.line = "hv", # Add medians survival
                      pval = TRUE, # Add p-value and tervals 
                      conf.int = TRUE, # Add the 95% confidence band
                      risk.table = TRUE, # Add risk table
                      tables.height = 0.2,
                      tables.theme = theme_cleantable(),
                      palette = c("red","blue"),
                      ggtheme = theme_bw(),
                      title = subset)
  print(survp)
  splots[[g]] <- survp
  g = g + 1
}


for (i in names(deg_myeloid_checkpt_list) ) {
  # i = names(deg_list) [1]
  subset = paste0(i)
  print(subset)
  v = as.numeric(es.max_myeloid[,i]) 
  phe$v <- v
  head(phe)
  sur.cut <- surv_cutpoint(phe,
                           time= 'time',
                           event = 'event' ,
                           variables = 'v',
                           minprop = 0.2)
  sur.cat <- surv_categorize(sur.cut)
  head(sur.cat)
  sfit <- survfit(Surv(time, event) ~ v, data = sur.cat)
  p_surv_cut <- ggsurvplot(sfit, data = phe,
                           surv.median.line = "hv", # Add medians survival
                           pval = TRUE, # Add p-value and tervals 
                           conf.int = TRUE, # Add the 95% confidence band
                           risk.table = TRUE, # Add risk table
                           tables.height = 0.2,
                           tables.theme = theme_cleantable(),
                           palette = c('red','blue'),
                           ggtheme = theme_bw(),
                           title = subset)
  print(p_surv_cut)
  csplots[[cg]] <- p_surv_cut
  cg = cg + 1
}  ### This gives Supplementary Figure S4A

















