## Supplementary Figure S4:

## loading the required R packages 
library(tidyverse)
library(Seurat)
library(ggplot2)
library(survival)
library(survminer)
library(GSVA)
library(iTALK)
library(Matrix)
library(dplyr)
library(dichromat)

## Figure S4A

# Need pre-processing the bulk-RNA seq data of the TCGA-BRCA cohort first: 

deg_myeloid_checkpt_list <- list('PD1' = c("PDCD1"), "SIRPA" = c("SIRPA"), "LILRB2" = c("LILRB2"))

### Calculate the gene enrichment score of myeloid immune checkpoints  
X=as.matrix(exprSet_basal)

es.max_spearman_myeloid_checkpt <- gsva(X, deg_myeloid_checkpt_list, min.sz > 1,
               mx.diff=FALSE, verbose=T, 
               parallel.sz=4)

es.max_spearman_myeloid_checkpt <- t(es.max_spearman_myeloid_checkpt)
es.max_spearman_myeloid_checkpt <- as.data.frame(es.max_spearman_myeloid_checkpt)

#####  KM-survival analysis

for (i in names(deg_myeloid_checkpt_list) ) {
  # i = names(deg_list) [1]
  subset = paste0('',i)
  print(subset)
  v = as.numeric(es.max_myeloid[,i]) 
  sub_group <- ifelse( v < 0,"low","high") 
  table(sub_group) 
  phe$sub_group=sub_group
  # Fit survival curves
  require("survival")
  fit <- survfit(Surv(time, event) ~ sub_group, data = phe)
  library("survminer")
  survp <- ggsurvplot(fit, data = phe,
                      surv.median.line = "hv", # Add medians survival
                      pval = TRUE, # Add p-value and tervals 
                      conf.int = TRUE, # Add the 95% confidence band
                      risk.table = TRUE, # Add risk table
                      tables.height = 0.2,
                      tables.theme = theme_cleantable(),
                      palette = c("red","blue"),
                      ggtheme = theme_bw(),
                      title = subset)
  print(survp)
  splots[[g]] <- survp
  g = g + 1
}


for (i in names(deg_myeloid_checkpt_list) ) {
  # i = names(deg_list) [1]
  subset = paste0(i)
  print(subset)
  v = as.numeric(es.max_myeloid[,i]) 
  phe$v <- v
  head(phe)
  sur.cut <- surv_cutpoint(phe,
                           time= 'time',
                           event = 'event' ,
                           variables = 'v',
                           minprop = 0.2)
  sur.cat <- surv_categorize(sur.cut)
  head(sur.cat)
  sfit <- survfit(Surv(time, event) ~ v, data = sur.cat)
  p_surv_cut <- ggsurvplot(sfit, data = phe,
                           surv.median.line = "hv", # Add medians survival
                           pval = TRUE, # Add p-value and tervals 
                           conf.int = TRUE, # Add the 95% confidence band
                           risk.table = TRUE, # Add risk table
                           tables.height = 0.2,
                           tables.theme = theme_cleantable(),
                           palette = c('red','blue'),
                           ggtheme = theme_bw(),
                           title = subset)
  print(p_surv_cut)
  csplots[[cg]] <- p_surv_cut
  cg = cg + 1
}  ### This gives Supplementary Figure S4A


### Supplementary Figure S4B:

### Cell-cell Communication analysis using iTalk R package:
epithelial_cell_seurat_filtered@meta.data$subtype <- epithelial_cell_seurat_filtered@meta.data$ploidy
testing <- merge(myeloid_seurat_filtered, y = c(epithelial_cell_seurat_filtered))

Idents(testing) <- "IHC"
testing_TNBC <- subset(testing, idents = "TNBC")
testing_TNBC@meta.data[testing_TNBC@meta.data$subtype == "unassigned_1", 'subtype'] <- 'U1'
testing_TNBC@meta.data[testing_TNBC@meta.data$subtype == "unassigned_2", 'subtype'] <- 'U2'

exp_1 <- as.data.frame(t(testing_TNBC[["RNA"]]$counts.1))
exp_2 <- as.data.frame(t(testing_TNBC[["RNA"]]$counts.2))
exp <- rbind(exp_1,exp_2)

exp$cell_type <- testing_TNBC@meta.data$subtype
exp$compare_group <- testing_TNBC@meta.data$IHC
length(unique(testing_TNBC$subtype))

highly_exprs_genes <- rawParse(exp,top_genes=50,stats='mean')







