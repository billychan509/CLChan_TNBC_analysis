library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)
library(enrichR)

# Please pre-process the TCGA-BRCA data first, we only need to the bulk-RNA seq data from the basal-like breast cancer patients for correlation analysis/ survival analysis:
# Figure 2a and 2d:

library(ggpubr)

ggscatter(df_spearmen, y = 'Phagocytosis signature', x = "FOLR2_signature",
          color = "black", shape = 21, size = 3.5, # Points color, shape and size
          add = "reg.line",  # Add regression line
          add.params = list(color = "red", fill = "lightgray"), # Customize reg. line
          conf.int = TRUE, # Add confidence interval
          cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
          cor.coeff.args = list(method = "spearman",  label.sep = "\n"),
          cor.coef.size = 4,
          font.label = c(22,"bold")) ## Figure 2a

ggscatter(df_spearmen, y = 'Phagocytosis signature', x = "FOLR2_signature",
          color = "black", shape = 21, size = 3.5, # Points color, shape and size
          add = "reg.line",  # Add regression line
          add.params = list(color = "red", fill = "lightgray"), # Customize reg. line
          conf.int = TRUE, # Add confidence interval
          cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
          cor.coeff.args = list(method = "spearman",  label.sep = "\n"),
          cor.coef.size = 4,
          font.label = c(22,"bold")) ## Figure 2d



# Figure 2b.

#Figure 2c, 2f:
GO_results_mac_FABP5  <- enrichGO(gene = c("FABP5", "SPP1", "PLIN2", "SCARB2", "CTSL", "SLC11A1", "BRI3", "LHFPL2", "GPNMB", "GM2A", 
                                           "RNASE1", "TIMP2", "MSR1", "LAMP", "NUPR1", "FNIP2", "CTSD", "APOC1", "CSTB", "ACP5", "RALA"), 
                                 OrgDb = "org.Hs.eg.db", 
                                 keyType = "SYMBOL", 
                                 ont = "BP",
                                 pvalueCutoff = 0.05,
                                 qvalueCutoff = 0.05)

plot(barplot(GO_results_mac_FABP5, showCategory =  c('lipid transport','regulation of lipid localization',
                                                     'lipid storage','antigen processing and presentation of peptide antigen',
                                                     'antigen processing and presentation of exogenous peptide antigen via MHC class II'),
             title = "Enriched Biological Processes (mac_FABP5)", font.size = 13)) #Figure 2c,



GO_results_mac_APOE  <- enrichGO(gene = c("ADAMDEC1", "ACP5", "PLD3", "LIPA", "KCNMA1", "GM2A", "SCPEP1", "SERPING1", "APOE", "TSPAN4",
                                            "CTSC", "TMEM176A", "DNASE2", "TMEM176B", "LILRB4", "C2", "A2M", "AKR1B1", "C1QA", "C1QB", "LGMN"), 
                        OrgDb = "org.Hs.eg.db", 
                        keyType = "SYMBOL", ont = "BP",
                        pvalueCutoff = 0.05,
                        qvalueCutoff = 0.05) 

plot(barplot(GO_results_mac_APOE, showCategory =  c("complement activation, classical pathway",'complement activation, lectin pathway'
                                                    ,'humoral immune response','production of molecular mediator involved in inflammatory response',
                                                    "lipid storage", 'lipoprotein catabolic process'),
             title = "Enriched Biological Processes (mac_APOE)", font.size = 13)) #Figure 2f.


### Figure 2h: Cell-cell communication analysis by CellChat:
library(CellChat)
library(Seurat)
library(NMF)
library(ggalluvial)

levels(NKT_CAF_myeloid_seurat_TNBC)
Idents(NKT_CAF_myeloid_seurat_TNBC) <- "IHC"
NKT_CAF_myeloid_seurat <- merge(NK_T_cells_seurat, y = c(myeloid_seurat_filtered, CAF_seurat_filtered))
NKT_CAF_myeloid_seurat@meta.data$subtype_IHC <- paste0(NKT_CAF_myeloid_seurat@meta.data$subtype,"_",NKT_CAF_myeloid_seurat@meta.data$IHC)
unique(NKT_CAF_myeloid_seurat@meta.data$subtype_IHC)

NKT_CAF_myeloid_seurat <- JoinLayers(NKT_CAF_myeloid_seurat)
Idents(NKT_CAF_myeloid_seurat) <- "IHC"
NKT_CAF_myeloid_seurat_TNBC <- subset(NKT_CAF_myeloid_seurat, idents = "TNBC")
Idents(NKT_CAF_myeloid_seurat_TNBC) <- "subtype_IHC"
meta <- NKT_CAF_myeloid_seurat_TNBC[["RNA"]]$counts

# Information about cell type
Idents(NKT_CAF_myeloid_seurat_TNBC) = "subtype_IHC"

idents = data.frame(row.names=rownames(NKT_CAF_myeloid_seurat_TNBC@meta.data), 
                    celltype=Idents(NKT_CAF_myeloid_seurat_TNBC))
head(idents)

cellchat <- createCellChat(NKT_CAF_myeloid_seurat_TNBC , group.by='ident')

levels(cellchat@idents)
CellChatDB <- CellChatDB.human 
showDatabaseCategory(CellChatDB)
dplyr::glimpse(CellChatDB$interaction)

unique(CellChatDB$interaction$pathway_name) # looking into the pathway names

# subset expression data:
cellchat <- subsetData(cellchat) 

#Identifying overexpressed receptor-ligand pairs 
cellchat <- identifyOverExpressedGenes(cellchat)

#Identifying overexpressed receptor-ligand interactins 
cellchat <- identifyOverExpressedInteractions(cellchat)

# Smoothening the expression value:
cellchat <- projectData(cellchat, PPI.human)

# Calculate communication probability
cellchat <- computeCommunProb(cellchat, raw.use = TRUE)    

# Filter communication patterns:
cellchat <- filterCommunication(cellchat, min.cells = 10)

#Computing the communication probability
cellchat <- computeCommunProbPathway(cellchat)
cellchat@netP

### aggregate the communication network:
cellchat <- aggregateNet(cellchat)
groupSize <- as.numeric(table(cellchat@idents))

netVisual_aggregate(cellchat, signaling = "MIF",
                   targets.use= c("mac_FABP5_TNBC", "mac_APOE_TNBC"),
                   sources.use = c("Mreg_TNBC", "CD4_Treg_TNBC","mCAF_TNBC"),
                    remove.isolate = T, cell.order = T, thresh = 0.01) ### This will eventually gives the figure 2h

####Figure 2g.
Idents(myeloid_seurat_filtered) <- "IHC"
myeloid_seurat_filtered_TNBC <- subset(myeloid_seurat_filtered, idents = "TNBC")

AverageHeatmap(object = myeloid_seurat_filtered_TNBC,
               markerGene = c("IGF1", "LYZ", "CSTB", "CTSD", "CTSZ", "CTSB", "CTSL", "CTSS",
                              "CALR", "CREG1", "NPC2", "CD63", "SDCBP", "PSAP", "SPP1"), cluster_columns = T)

##### Figure 2I Speramen correlation analysis:
mac_APOE_refined_genes <- c('ADAMDEC1', 'ACP5', 'PLD3', 'LIPA', 'KCNMA1', 'GM2A', 'SCPEP1', 'SERPING1', 
                            'APOE', 'TSPAN4', 'CTSC', 'TMEM176A', 'DNASE2', 
                            'TMEM176B', 'LILRB4', 'C2', 'A2M', 'AKR1B1',
                             'C1QA', 'C1QB', 'LGMN') ## genes obtained by comparing  mac_APOE signature of Wu et al. (2021) and that of Pal et al. (2021)

mac_FABP5_refined_genes <- c("FABP5", "SPP1", "PLIN2", "SCARB2", "CTSL", "SLC11A1", "BRI3", "LHFPL2", 
                             "GPNMB", "GM2A", "RNASE1", "TIMP2", "MSR1", "LAMP", "NUPR1", "FNIP2",
                             "CTSD", "APOC1", "CSTB", "ACP5", "RALA") ## genes obtained by comparing  mac_FABP5 signature of Wu et al. (2021) and that of Pal et al. (2021)

deg_list_spearmen_NFKB_pathway <-  list('mac_FABP5' = mac_FABP5_refined_genes, 'mac_APOE' = mac_APOE_refined_genes, "NFKB1" = c("NFKB1"),
                         "NFKB2" = c("NFKB2"), "NFKBIA" = c("NFKBIA"), "NEMO" = c("IKBKG"),  "IKKα" = c("CHUK"), "IKKβ" = c("IKBKB")) 

X=as.matrix(exprSet_basal)
es.max_spearman_NF_KB_pathway<- gsva(X, deg_list_spearmen_NFKB_pathway, 
                                  mx.diff=FALSE, verbose=T, 
                                  parallel.sz=4)

library(ComplexHeatmap)
library(circlize)

Heatmap(cor(as.matrix(df_spearmen), method = c('spearman')), border = T,
        col = colorRamp2(c(-1,-0.5, 0,0.5, 1), c("blue","cornflowerblue", "white", "brown1","red3"))) ## this gives Figure 2i
















