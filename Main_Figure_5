### loading the required library:
library(tidyverse)
library(Seurat)
library(scRNAtoolVis)
library(ggplot2)
library(clusterProfiler)
library(org.Hs.eg.db)
library(UCell)

### need to pre-process the scRNA-seq data of Zhang et al. (2021) first

## Figure 5a:
# No code has been provided for this figure since it was created with BioRender.



table(myeloid_combination_therapy_responder_seurat@meta.data$myeloids_subclusters) 

prop.table(table(Idents(myeloid_combination_therapy_responder_seurat)))
table(Idents(myeloid_combination_therapy_responder_seurat), myeloid_combination_therapy_responder_seurat$treatment_state) 

Cellratio <- prop.table(table(Idents(myeloid_combination_therapy_responder_seurat), myeloid_combination_therapy_responder_seurat$treatment_state), margin = 2) # calculate the proportion of different cell types 
Cellratio <- as.data.frame(Cellratio)

Cellratio_sorted <- Cellratio[c(3, 4, 1, 2),]
rownames(Cellratio_sorted) <- c(1,2,3,4)

ggplot(Cellratio_sorted) + 
  geom_bar(aes(x = Var2, y= Freq, fill = Var1, size = 1), stat = "identity" , width = 0.7, size = 0, colour ='#222222') + 
  theme_classic() +
  labs(x='', y = 'Ratio', fill = "myeloid subtypes", size = 20) +
  scale_fill_manual(values = c("firebrick1",'dodgerblue')) +
  theme(panel.border = element_rect(fill=NA,color="black", size=0, linetype="solid")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 16, color = 'black'), 
        axis.title.y = element_text(size = 16))

## Figure 5b (DONE)
VlnPlot(combination_therapy_responder_seurat,
        features = "mac_APOE_signature", split.by = 'treatment_state', sort = 'increasing', cols = c('tomato','dodgerblue1')) + geom_boxplot(width = 0.2, fill = 'white') ### ylab is added using notability manually

## Figure 5c (DONE)
VlnPlot(myeloid_chem_responder_seurat_all, split.by = 'treatment_state', 
        features = 'mac_APOE_signature',cols = c('tomato','dodgerblue1'), sort = 'decreasing') + geom_boxplot(width = 0.2, fill = 'white')

## Figure 5d (DONE)
VlnPlot(combination_therapy_responder_seurat,
        features = "myeloid_inflammatory_signature", split.by = 'treatment_state', sort = 'increasing', 
        cols = c('tomato','dodgerblue1')) + geom_boxplot(width = 0.2, fill = 'white') ### ylab is added using notability manually

## Figure 5e (DONE)
VlnPlot(myeloid_chem_responder_seurat_all, features = "myeloid_inflammatory_signature", 
        split.by = 'treatment_state', sort = 'increasing', cols = c('tomato','dodgerblue1')) + geom_boxplot(width = 0.2, fill = 'white') ### ylab is added using notability manually

## Figure 5f

## Figure 5g

## Figure 5h

## Figure 5i

## Figure 5j (DONE):
jjDotPlot(object = mac_APOE_combination_therapy_responder_seurat_post_treatment,
          gene = c("CCL2","CCL3","CCL4","CCL5","CCL3L1"),
          rescale = T,
          rescale.max = 5,
          rescale.min = -5,
          point.geom = F,
          anno = T,
          id = "idents",
          ytree = F,
          xtree = F,
          dot.col = c("#0099CC",'white', "red")) 

## Figure 5k (DONE):
jjDotPlot(object = mac_APOE_combination_therapy_responder_seurat_post_treatment,
          gene = c("FCGR1A", "FCGR2A","FCGR3A","TLR2", "TLR4", "NCF2", "NCF4", "DOCK2"),
          rescale = T,
          rescale.max = 5,
          rescale.min = -5,
          point.geom = F,
          anno = T,
          id = "idents",
          ytree = F,
          xtree = F,
          dot.col = c("#0099CC",'white', "red")) 

## Figure 5l (DONE):
phagocytosis_genes <- c("FCGR1A", "FCGR2A","FCGR3A","TLR2", "TLR4", "NCF2", "NCF4", "DOCK2")

GO_results <- enrichGO(gene = c("CCL2","CCL3","CCL4","CCL5","CCL3L1",phagocytosis_genes), 
                       OrgDb = "org.Hs.eg.db", 
                       keyType = "SYMBOL", ont = "BP",
                       pvalueCutoff = 0.05,  ## setting p-value
                       qvalueCutoff = 0.05)  ## setting q-value
plot(barplot(GO_results, showCategory = c("positive regulation of phagocytosis","T cell chemotaxis",
                                          "natural killer cell chemotaxis","granulocyte chemotaxis","neutrophil chemotaxis",
                                          'monocyte chemotaxis','macrophage chemotaxis'), 
             font.size = 13.5, title = "Enriched Biological processes \n(FOLR2_high mac)"))
## Figure 5m

## Figure 5n:
# No code has been provided for this figure since it was created with BioRender.
